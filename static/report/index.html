<!DOCTYPE html>
<html>
<head>
  <title>The Things And Stuff Revenue Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
      <![endif]-->
      <style>
        
      </style>
    </head>
    <body>


     <div class="container-liquid">
       <div class="">
         <h1>TheThingsAndStuff Revenue Report</h1>
         <hr>
         <div class="pull-left">
           <div class="form-group">
             <label for="">sort by: </label>
             <select name="order_by" id="order_by" class="form-control">
               <option value="id">ID</option>
               <option value="order_date">Order Date</option>
               <option value="order_type">Order Type</option>
               <option value="service_date">Service Date</option>
               <option value="total_paid">Total Paid</option>
               <option value="delivery_address">Delivery Address</option>
               <option value="tax">Tax</option>
               <option value="customer_name">Customer Name</option>
               <option value="magento_order_id">Magento Order ID</option>
             </select>
           </div>
           <div class="form-group">
             <label for="">sort direction: </label>
             <select name="order" id="order" class="form-control">
               <option value="ASC">Ascending</option>
               <option value="DESC">Descending</option>
             </select>
           </div>
         </div>
         <div class="table-responsive">
           <table class="table table-striped">
             <thead>
               <tr>
                 <th>Status</th>
                 <th>Order Date</th>
                 <th>Type</th>
                 <th>Customer</th>
                 <th>Service Date</th>
                 <th>Total Paid</th>
                 <th>Delivery Address</th>
                 <th>Tax</th>
                 <th>Item 1</th>
                 <th>Price</th>
                 <th>Item 2</th>
                 <th>Price</th>
                 <th>Item 3</th>
                 <th>Price</th>
                 <th>Item 4</th>
                 <th>Price</th>
                 <th>Item 5</th>
                 <th>Price</th>
               </tr>
             </thead>
             <tbody id="tablecontents">
               <tr>
                 <td>Locked</td>
                 <td>01/23/1232</td>
                 <td>Sale</td>
                 <td>Cooper M</td>
                 <td>05/12/2321</td>
                 <td>$100</td>
                 <td>13 asdasd \n adsa as, 13123</td>
                 <td>$9</td>
                 <td>White Desk</td>
                 <td>$10</td>
                 <td>Blue Hat</td>
                 <td>$12</td>
                 <td></td>
                 <td></td>
                 <td></td>
                 <td></td>
                 <td></td>
                 <td></td>
               </tr>
             </tbody>
           </table>
           <ul class="pager">
             <li class="previous" id="prev_page"><a href="#">&larr; Older</a></li>
             <li class="next" id="next_page"><a href="#">Newer &rarr;</a></li>
           </ul>
           <div class="pull-right">
             <div class="form-group">
               <label for="">per page: </label>
               <select name="per_page" id="per_page" class="form-control">
                 <option value="30">30</option>
                 <option value="50">50</option>
                 <option value="100">100</option>
                 <option value="200">200</option>
               </select>
             </div>
           </div>
         </div>
     </div>

   </div><!-- /.container -->

   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://code.jquery.com/jquery.js"></script>
   <!-- Include all compiled plugins (below), or include individual files as needed -->
   <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
   <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
   <script src="js/bootstrap.min.js"></script>
   <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.0/jquery.cookie.min.js"></script>
   <script type="text/javascript">
   $.each(['per_page','order','order_by'], function(index, val) {
     if (typeof $.cookie(val) == "undefined") {
      $.cookie(val, $("select#"+val).val(), { expires: 30 });
     } else {
      $("select#"+val).val($.cookie(val));
     };
     $("select#"+val).change(function(event) {
       $.cookie($(this).attr('name'),$(this).val(), { expires: 30 });
       location.reload();
     });
   });
    page = getParameterByName("page") == "" ? 1 : parseInt(getParameterByName("page"));
    $.ajax({
      url: '/static/report/fetch.php?order_by='+$.cookie('order_by')+'&order='+$.cookie('order')+'&per_page='+$.cookie('per_page')+"&page="+page,
      type: 'GET',
      dataType: 'text',
      data: {},
      success: function(data) {
      }
    })
    .done(function(data) {
      $("#tablecontents").html('');
      parsed_data = JSON.parse(data);
      $.each(parsed_data, function(index, val) {
        editing_mode = val.locked == "1" ? false : true;
        locked_html = editing_mode ?  "<button type=\"button\" class='btn btn-warning editing' data-id="+val.id+">Editing</button><br><button type=\"button\" class='btn btn-danger delete' data-id="+val.id+">Delete</button>" : "<button type=\"button\" class='btn btn-default locked' data-id="+val.id+">Locked</button>";
        service_date = val.service_date == "0000-00-00" ? "(Not Set)" : val.service_date;
        tax = "(not set)";
        for (var i = 1; i <= 5; i++) {
          items_index = i - 1;
          if (typeof val.items[items_index] == "undefined") {
            window['item'+i] = "";
            window['item'+i+'_price'] = "";
          } else {
            window['item'+i] = val.items[items_index].item;
            window['item'+i+'_price'] = val.items[items_index].price;
          }
        };
        if (editing_mode) {
          $("#tablecontents").append('<tr id="row-'+val.id+'" data-row="'+val.id+'"><td class="locked">'+locked_html+'</td><td class="order_date"><input class="order_date" name="order_date" type="text" value="'+val.order_date+'"></input></td><td class="order_type" value="'+val.order_type+'"></td><td class="customer_name"><input class="customer_name" name="customer_name" type="text" value="'+val.customer_name+'"></input></td><td class="service_date"><input class="service_date" name="service_date" type="text" value="'+service_date+'"></input></td><td class="order_price"><input class="total_paid" name="total_paid" type="text" value="'+val.total_paid+'"></input></td><td class="delivery_address"><input class="shipping_street" name="shipping_street" type="text" value="'+val.shipping_street+'"></input><br><input class="shipping_city" name="shipping_city" type="text" value="'+val.shipping_city+'"></input><input class="shipping_region" name="shipping_region" type="text" value="'+val.shipping_region+'"></input> <input class="shipping_postal" name="shipping_postal" type="text" value="'+val.shipping_postal+'"></input></td><td class="tax">'+tax+'</td><td>'+item1+'</td><td>'+item1_price+'</td><td>'+item2+'</td><td>'+item2_price+'</td><td>'+item3+'</td><td>'+item3_price+'</td><td>'+item4+'</td><td>'+item4_price+'</td><td>'+item5+'</td><td>'+item5_price+'</td></tr>');  
        } else{
          $("#tablecontents").append('<tr id="row-'+val.id+'"><td class="locked">'+locked_html+'</td><td class="order_date">'+val.order_date+'</td><td class="order_type">'+val.order_type+'</td><td class="customer_name">'+val.customer_name+'</td><td class="service_date">'+service_date+'</td><td class="order_price">$'+val.total_paid+'</td><td class="delivery_address">'+val.shipping_street+'<br>'+val.shipping_city+', '+val.shipping_region+' '+val.shipping_postal+'</td><td class="tax">'+tax+'</td><td>'+item1+'</td><td>'+item1_price+'</td><td>'+item2+'</td><td>'+item2_price+'</td><td>'+item3+'</td><td>'+item3_price+'</td><td>'+item4+'</td><td>'+item4_price+'</td><td>'+item5+'</td><td>'+item5_price+'</td></tr>');
        }
        $("input.order_date,input.service_date").datepicker();
      });


      // pager
      if (getParameterByName("page") == "" || parseInt(getParameterByName("page")) == 1 ) {
        $("li#prev_page").addClass("disabled");
        $("li#next_page a").attr('href',updateQueryStringParameter(window.location.href,"page", "2") );
      } else if (parseInt(getParameterByName("page")) > 1) {
        $("li#prev_page a").attr('href',updateQueryStringParameter(window.location.href,"page", (parseInt(getParameterByName("page")) - 1) ) );
        $("li#next_page a").attr('href',updateQueryStringParameter(window.location.href,"page", (parseInt(getParameterByName("page")) + 1) ) );
      };

    });

    $("#tablecontents").delegate("button.locked", 'click',function(e) {
      row_id = $(this).data("id");
      $.ajax({
        url: '/static/report/api.php',
        type: 'POST',
        dataType: 'text',
        data: {
          action: 'unlock_row',
          row_id: row_id
        },
      })
      .done(function(data) {
        if (data == "success") {
          $("tr#row-"+row_id+" td.locked").html("<button type=\"button\" class='btn btn-warning editing' data-id="+row_id+">Editing</button><br><button type=\"button\" class='btn btn-danger delete' data-id="+row_id+">Delete</button>");
        };
      });
    });
    // hover event on button
    $("#tablecontents").delegate("button.editing", "mouseenter", function(e) {
      $(this).text("Save");
    }).delegate("button.editing", "mouseleave", function(e) {
      $(this).text("Editing");
    });
    // remember to update inputs later
    $("#tablecontents").delegate("input[type=text]", "change", function(e) {
      $(this).addClass("save");
    });

    $("#tablecontents").delegate("button.editing", 'click', function(e) {
      row_id = $(this).data("id");
      $.ajax({
        url: '/static/report/api.php',
        type: 'POST',
        dataType: 'text',
        data: {
          action: 'lock_row',
          row_id: row_id
        },
      })
      .done(function(data) {
        if (data == "success") {
          $("tr#row-"+row_id+" td.locked").html("<button type=\"button\" class='btn btn-default locked' data-id="+row_id+">Locked</button>");
        };
      });
      // update the data
      $row = $(this).closest("tr");
      $row.find("input.save").each(function() {
        column_name = $(this).attr("name");
        new_value = $(this).val();
        $.ajax({
          url: '/static/report/api.php',
          type: 'POST',
          dataType: 'text',
          data: {
            action: 'update_column',
            row_id: row_id,
            column_name: column_name,
            new_value: new_value
          },
        })
        .done(function(data) {
          if (data == "success") {
            $row.find("input").each(function() {
              value = $(this).val();
              $(this).replaceWith(value);
            })
          };
        });
      });
    });

    // datepicker


function updateQueryStringParameter(uri, key, value) {
  var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
  var separator = uri.indexOf('?') !== -1 ? "&" : "?";
  if (uri.match(re)) {
    return uri.replace(re, '$1' + key + "=" + value + '$2');
  }
  else {
    return uri + separator + key + "=" + value;
  }
}
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}
  </script>
</body>
</html>






